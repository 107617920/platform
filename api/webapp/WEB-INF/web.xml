<?xml version="1.0" encoding="UTF-8"?>
<web-app xmlns="http://java.sun.com/xml/ns/j2ee"
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:schemaLocation="http://java.sun.com/xml/ns/j2ee http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"
     version="2.4">
    <display-name>LabKey Server</display-name>

    <listener>
        <listener-class>org.labkey.api.util.ContextListener</listener-class>
    </listener>

    <filter>
        <filter-name>Form Authentication Filter</filter-name>
        <description/>
        <filter-class>org.labkey.api.security.AuthFilter</filter-class>
    </filter>
    <filter>
        <filter-name>Transaction Filter</filter-name>
        <filter-class>org.labkey.api.data.TransactionFilter</filter-class>
    </filter>

    <!-- filter for fast polling -->
    <filter>
        <filter-name>PollingFilter</filter-name>
        <filter-class>org.labkey.api.util.PollingUtil$PollingFilter</filter-class>
    </filter>
    
    <!-- Example filter to set character encoding on each request -->
    <filter>
        <filter-name>Set Character Encoding</filter-name>
        <filter-class>org.labkey.core.filters.SetCharacterEncodingFilter</filter-class>
        <init-param>
            <param-name>encoding</param-name>
            <param-value>UTF-8</param-value>
        </init-param>
        <init-param>
            <param-name>ignore</param-name>
            <param-value>false</param-value>
        </init-param>
    </filter>

    <filter-mapping>
        <filter-name>PollingFilter</filter-name>
        <url-pattern>*.poll</url-pattern>
    </filter-mapping>


    <filter>
        <filter-name>ShortURLFilter</filter-name>
        <filter-class>org.labkey.core.view.ShortURLFilter</filter-class>
    </filter>
    <filter-mapping>
        <filter-name>ShortURLFilter</filter-name>
        <url-pattern>*.url</url-pattern>
    </filter-mapping>

    <filter>
        <filter-name>Module Loader</filter-name>
        <filter-class>org.labkey.api.module.ModuleLoader</filter-class>
    </filter>

    <filter-mapping>
        <filter-name>Form Authentication Filter</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>

    <filter-mapping>
        <filter-name>Module Loader</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>

    <filter-mapping>
        <filter-name>Set Character Encoding</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>

    <filter-mapping>
        <filter-name>Transaction Filter</filter-name>
        <url-pattern>*.jsp</url-pattern>
    </filter-mapping>
    <filter-mapping>
        <filter-name>Transaction Filter</filter-name>
        <url-pattern>*.jpf</url-pattern>
    </filter-mapping>
    <filter-mapping>
        <filter-name>Transaction Filter</filter-name>
        <url-pattern>*.do</url-pattern>
    </filter-mapping>
    <filter-mapping>
        <filter-name>Transaction Filter</filter-name>
        <url-pattern>*.view</url-pattern>
    </filter-mapping>
    <filter-mapping>
        <filter-name>Transaction Filter</filter-name>
        <url-pattern>*.api</url-pattern>
    </filter-mapping>
    <filter-mapping>
        <filter-name>Transaction Filter</filter-name>
        <url-pattern>*.post</url-pattern>
    </filter-mapping>

    <servlet>
        <servlet-name>ViewServlet</servlet-name>
        <servlet-class>org.labkey.api.view.ViewServlet</servlet-class>
        <load-on-startup>1</load-on-startup>
    </servlet>

    <servlet>
        <servlet-name>Kaptcha</servlet-name>
        <servlet-class>com.google.code.kaptcha.servlet.KaptchaServlet</servlet-class>
    </servlet>
    <servlet-mapping>
        <servlet-name>Kaptcha</servlet-name>
        <url-pattern>/kaptcha.jpg</url-pattern>
    </servlet-mapping>

    <!--
    EXPERIMENTAL:
    File Servlet. Maps standard requests for files onto the filecontent module.
    Requests like http://host/labkey/files/home/test.pdf become
    http://host/labkey/filecontent/home/sendFile.view?fileName=test.pdf
    see http://host/labkey/filecontent/home/begin.view for description of how to
    set up a static web parallel to the labkey folder hierarchy
    -->
    <servlet>
        <servlet-name>FileServlet</servlet-name>
        <servlet-class>org.labkey.api.view.FileServlet</servlet-class>
    </servlet>
    <!--
    EXPERIMENTAL:
    CGI Servlet. Parameters are shown below.
    cgiDir is most important parameter. cgi scripts will be searched in this directory
    subdirectories will NOT be searched. See servlet mapping for example URLs
    perl is the default executable so it does not have to be specified as shown here..

    Used in conjunction with frame.view action from the filecontent module
    cgi scripts can be look somewhat integrated with the rest of the site.
    E.g. http://host/labkey/filecontent/home/folder/frame.view?src=http://host/labkey/cgi/home/folder/test.pl

    <servlet>
        <servlet-name>CgiServlet</servlet-name>
        <servlet-class>org.labkey.api.view.CGIServlet</servlet-class>
        <init-param>
            <param-name>cgiDir</param-name>
            <param-value>/projects/home/cgi</param-value>
        </init-param>
        <init-param>
            <param-name>debug</param-name>
            <param-value>0</param-value>
        </init-param>
        <init-param>
            <param-name>executable</param-name>
            <param-value>perl</param-value>
        </init-param>
    </servlet>
    -->

    <servlet>
        <servlet-name>ImageServlet</servlet-name>
        <servlet-class>org.labkey.api.attachments.ImageServlet</servlet-class>
    </servlet>


    <servlet>
        <servlet-name>ScssServlet</servlet-name>
        <servlet-class>org.labkey.api.scss.ScssServlet</servlet-class>
    </servlet>

    <servlet>
        <servlet-name>static</servlet-name>
        <servlet-class>org.labkey.core.webdav.WebdavServlet</servlet-class>
        <init-param>
          <param-name>resolver</param-name>
          <param-value>org.labkey.api.webdav.ModuleStaticResolverImpl</param-value>
        </init-param>
    </servlet>
    
    <servlet>
        <servlet-name>SiteDownServlet</servlet-name>
        <servlet-class>org.labkey.api.view.SiteDownServlet</servlet-class>
        <init-param>
            <param-name>message</param-name>
            <param-value>This LabKey Server is currently down for maintenance.</param-value>
        </init-param>
    </servlet>

    <!--
        even though there is one webdav tree rooted at "/" we still use two servlet bindings.
        This is because we want /_webdav/* to be resolve BEFORE all other servlet-mappings
        and /* to resolve AFTER all other servlet-mappings
    -->
    <servlet-mapping>
        <servlet-name>static</servlet-name>
        <url-pattern>/_webdav/*</url-pattern>
    </servlet-mapping>

    <!-- To display a nice error message in the case of a database error, remove the
         comments around this servlet-mapping and edit the message in the init-param
         above.
    <servlet-mapping>
        <servlet-name>SiteDownServlet</servlet-name>
        <url-pattern>/*</url-pattern>
    </servlet-mapping>
    -->

    <servlet-mapping>
        <servlet-name>ViewServlet</servlet-name>
        <url-pattern>*.view</url-pattern>
    </servlet-mapping>
    <servlet-mapping>
        <servlet-name>ViewServlet</servlet-name>
        <url-pattern>*.api</url-pattern>
    </servlet-mapping>
    <servlet-mapping>
        <servlet-name>ViewServlet</servlet-name>
        <url-pattern>*.post</url-pattern>
    </servlet-mapping>
    <servlet-mapping>
        <servlet-name>ImageServlet</servlet-name>
        <url-pattern>*.image</url-pattern>
    </servlet-mapping>
    <!--
    maps http://host/labkey/files/proj/dir/test.html to
    http://host/labkey/filecontent/proj/dir/sendFile.view?file=test.html
    -->
    <servlet-mapping>
        <servlet-name>FileServlet</servlet-name>
        <url-pattern>/files/*</url-pattern>
    </servlet-mapping>

    <servlet-mapping>
        <servlet-name>ScssServlet</servlet-name>
        <url-pattern>*.scss</url-pattern>
    </servlet-mapping>

    <servlet-mapping>
        <servlet-name>static</servlet-name>
        <url-pattern>/</url-pattern>
    </servlet-mapping>
    
    <welcome-file-list>
        <welcome-file>/</welcome-file>
    </welcome-file-list>

    <resource-ref>
        <res-ref-name>mail/Session</res-ref-name>
        <res-type>javax.mail.Session</res-type>
        <res-auth>Container</res-auth>
    </resource-ref>

    <mime-mapping>
        <extension>wsdl</extension>
        <mime-type>text/xml</mime-type>
    </mime-mapping>

    <mime-mapping>
        <extension>xsd</extension>
        <mime-type>text/xml</mime-type>
    </mime-mapping>

</web-app>
